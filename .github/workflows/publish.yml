name: publish site
on:
  push:
    branches:
      - main  # あなたのメインブランチ名に合わせてください

permissions:
  contents: write

jobs:
  deploy:
    # デプロイ環境
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          # Pythonのバージョンを指定
          python-version: 3.x
      - run: | # MkDocsと必要なプラグインをインストール
          pip install mkdocs-material
          pip install mkdocs-table-reader-plugin

      # MkDocsを使用してサイトをビルドし、GitHub Pagesにデプロイ
      - run: mkdocs gh-deploy --force

      # Discord Webhookを使用してデプロイ完了を通知
      - name: Discord Notification
        if: always() # デプロイが成功してもしなくても通知を送る
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }} # GitHub Secretsに設定したWebhook URLを使用
          STATUS: ${{ job.status }} # ジョブのステータスを取得
          SITE_URL: "https://firesepichub-14.github.io"
          RUN_URL: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          RAW_COMMIT_MSG: ${{ github.event.head_commit.message }}
          # 16進数カラーコードを10進数に変換しなければ...
          # ミク色:39C5BB --> 3786171
          # テト色:e25577 --> 14832503
        run: |
          # 1. デプロイの成功/失敗に応じてメッセージとカラーを設定
          if [ "$STATUS" == "success" ]; then
            TITLE="🚀 MkDocs デプロイ成功！"
            COLOR=3786171
            DESC_MSG_L1="✅ サイトが正常にデプロイされました！"
            DESC_MSG_L2="　　サイトが最新の状態に更新されました！"
            CONTENT=""
          else
            TITLE="❌ MkDocs デプロイ失敗..."
            COLOR=14832503
            DESC_MSG_L1="⚠️ デプロイに失敗しました。"
            DEsC_MSG_L2="　　詳細は以下のボタンから確認してください。"
            CONTENT="<@791925284009017344>"
          fi
          
          # 2. 情報をまとめる（MDにシフト）
          # あらかじめJQを使ってきれいにまとめる
          DESC_TEST=$(jq -rn \
            --arg r "${{ github.repository }}" \
            --arg b "${{ github.ref_name }}" \
            --arg c "$RAW_COMMIT_MSG" \
            --arg a "${{ github.actor }}" \
            --arg l1 "$DESC_MSG_L1" \
            --arg l2 "$DESC_MSG_L2" \
            --arg s_url "$SITE_URL" \
            --arg r_url "$RUN_URL" \
            '"リポジトリ：　`" + $r + "`\n" +
            "ブランチ：　`" + $b + "`\n" +
            "コミット：　`" + $c + "`\n" +
            "アクター：　`" + $a + "`\n\n" +
            $l1 + "\n" + $l2 + "\n\n" +
            "━━━━━━━━━━━━━━━━━━━━━━━━\n" +
            "🔗 **[サイトを確認する](" + $s_url + ")**\n" +
            "🛠️ **[実行ログを確認する](" + $r_url + ")**\n" +
            "━━━━━━━━━━━━━━━━━━━━━━━━\n"')
          
          # 3. Webhookに送るペイロードを作成
          PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg color $COLOR \
            --arg desc "$DESC_TEST" \
            --arg content "$CONTENT" \
            '{
              "content": $content,
              "embeds": [{
                "title": $title,
                "description": $desc,
                "color": ($color | tonumber)
              }]
            }')
          
          curl -H "Content-Type: application/json" -X POST -d "$PAYLOAD" "$WEBHOOK_URL?wait=true" --fail --verbose