name: publish site
on:
  push:
    branches:
      - main  # ã‚ãªãŸã®ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒåã«åˆã‚ã›ã¦ãã ã•ã„

permissions:
  contents: write

jobs:
  deploy:
    # ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          # Pythonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®š
          python-version: 3.x
      - run: | # MkDocsã¨å¿…è¦ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pip install mkdocs-material
          pip install mkdocs-table-reader-plugin

      # MkDocsã‚’ä½¿ç”¨ã—ã¦ã‚µã‚¤ãƒˆã‚’ãƒ“ãƒ«ãƒ‰ã—ã€GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤
      - run: mkdocs gh-deploy --force

      # Discord Webhookã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’é€šçŸ¥
      - name: Discord Notification
        if: always() # ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¦ã‚‚ã—ãªãã¦ã‚‚é€šçŸ¥ã‚’é€ã‚‹
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }} # GitHub Secretsã«è¨­å®šã—ãŸWebhook URLã‚’ä½¿ç”¨
          STATUS: ${{ job.status }} # ã‚¸ãƒ§ãƒ–ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
          SITE_URL: "https://firesepichub-14.github.io"
          RUN_URL: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          RAW_COMMIT_MSG: ${{ github.event.head_commit.message }}
          # 16é€²æ•°ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’10é€²æ•°ã«å¤‰æ›ã—ãªã‘ã‚Œã°...
          # ãƒŸã‚¯è‰²:39C5BB --> 3786171
          # ãƒ†ãƒˆè‰²:e25577 --> 14832503
        run: |
          if [ "$STATUS" == "success" ]; then
            TITLE="ğŸš€ MkDocs ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸï¼"
            COLOR=3786171
            DESC_MSG_L1="âœ… ã‚µã‚¤ãƒˆãŒæ­£å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸï¼"
            DESC_MSG_L2="ã€€ã€€ã‚µã‚¤ãƒˆãŒæœ€æ–°ã®çŠ¶æ…‹ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸï¼"
            CONTENT=""
          else
            TITLE="âŒ MkDocs ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—..."
            COLOR=14832503
            DESC_MSG_L1="âš ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
            DEsC_MSG_L2="ã€€ã€€è©³ç´°ã¯ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            CONTENT="<@791925284009017344>" s
          fi
          
          PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --argjson color $COLOR \
            --arg commit "ã‚³ãƒŸãƒƒãƒˆ: $RAW_COMMIT_MSG" \
            --arg branch "ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}" \
            --arg repo "ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}" \
            --arg actor "ã‚¢ã‚¯ã‚¿ãƒ¼: ${{ github.actor }}" \
            --arg l1 "$DESC_MSG_L1" \
            --arg l2 "$DESC_MSG_L2" \
            --arg site_url "$SITE_URL" \
            --arg run_url "$RUN_URL" \
            --arg content "$CONTENT" \
            '{
              "content": $content,
              "embeds": [
                {
                  "title": $title,
                  "description": ($commit + "\n" + $branch + "\n" + $repo + "\n" + $actor + "\n\n" + $l1 + "\n" + $l2),
                  "color": $color | tonumber,
                  ],
                  components: [
                    {
                      "type": 1,
                      "components": [
                        {
                          "type": 2,
                          "label": "ã‚µã‚¤ãƒˆã‚’ç¢ºèª",
                          "style": 5,
                          "url": $site_url
                        },
                        {
                          "type": 2,
                          "label": "GitHub Actionsã‚’ç¢ºèª",
                          "style": 5,
                          "url": $run_url
                        }
                      ]
                    }
                  ]
                }
              ]
            }')
          
          curl -H "Content-Type: application/json" -X POST -d "$PAYLOAD" "$WEBHOOK_URL"